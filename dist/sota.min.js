!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("d3")):"function"==typeof define&&define.amd?define(["d3"],e):(t=t||self).sota=e(t.d3)}(this,(function(t){"use strict";function e(t,e){for(let l of t._groups)if(Array.isArray(l))for(let t of l)a(t,e);else a(l,e)}function a(t,e){t.getBBox().x<e&&(t.style.display="none")}function l(t){return d3.format(".1f")(t)+"%"}let s=2,r=32,n=16,o=6,i=8,c=32,p=24,h=24,g="#999999",d=300,m=8,u=30,f={barHeight:24,barMargin:8},x={top:20,bottom:20,left:0,right:0},y={between:12,belowBetween:8,right:24,width:32,height:24,below:16};let b={barChart:function({selector:e,dataFile:a,inputIsPercentage:i=!1,showXAxis:c=!0,showSeparators:g=!0,displayPercentage:d=!0,totalResp:u=null,maxVal:f=null,minVal:y=null,margin:b=x}){const v=m,w=s,B=o,A=r,C=n,k=h,$=p,j=t.select(e).append("svg"),N=t.select("body").append("div").attr("class","tooltip"),P=document.querySelector(e).offsetWidth,L=P-b.left-b.right,S=j.append("g").attr("class","sota-barChart-mainChart").attr("transform",`translate(${b.left+k} ${b.right})`).attr("width",L);t.csv(a+".csv").then(a=>{const s=A+C;let r,n=a.length*s;i?r=a.map(t=>+t.value).keys:(u=null==u?t.sum(a,t=>+t.value):u,r=a.map(t=>+t.value/u*100));const o=d||i?r:a.map(t=>+t.value);a.map(t=>t.label);if(null==y)y=i||d?0:t.min(o);else if(!0===y)y=t.min(o);else if(isNaN(y)||""===y)throw"invalid minVal for graph on "+e;if(null==f)f=i||d?100:t.max(o);else if(!0===f)f=t.max(o);else if(isNaN(f)||""===f)throw"invalid maxVal for graph on "+e;const p=t.scaleLinear().domain([y,f]).range([0,L]);let h;function m(t){return t*s}if(c&&(h=S.append("g").attr("class","sota-gen-axis sota-gen-xAxis").call(t.axisBottom(p).ticks(a.length).tickSize(-v)).attr("transform","translate(0 "+(n+$)+")")),S.selectAll(".sota-barChart-bar").data(o).join("rect").attr("class","sota-barChart-bar sota-gen-bar").attr("width",t=>p(t)).attr("height",A).attr("x",0).attr("y",(t,e)=>m(e)).on("mouseover",(function(e,s){t.select(this).attr("opacity",.8),N.style("opacity",1).html(()=>{let t=`<span class="sota-tooltip-label">${a[s].label}</span><br/>Percentage: ${l(r[s])}`;return i||(t+="<br/>Number of responses: "+a[s].value),t}).style("left",t.event.pageX+"px").style("top",t.event.pageY+"px")})).on("mousemove",e=>{N.style("left",t.event.pageX+"px").style("top",t.event.pageY+"px")}).on("mouseout",(function(e){t.select(this).attr("opacity",1),N.style("opacity",0)})),S.selectAll(".sota-barChart-label").data(a).join("text").attr("class","sota-barChart-label").html(t=>t.label).attr("alignment-baseline","central").attr("x",B).attr("y",(t,e)=>m(e)+A/2),g&&S.selectAll(".sota-barChart-separator").data(o).join("line").attr("class","sota-barChart-separator").attr("x1",0).attr("x2",L).attr("y1",(t,e)=>m(e)+A+6).attr("y2",(t,e)=>m(e)+A+6).attr("stroke-width",w).attr("stroke","#dddddd"),S.selectAll(".sota-barChart-value").data(o).join("text").attr("class","sota-barChart-value").html((t,e)=>i||d?l(t):t).attr("alignment-baseline","central").attr("text-anchor","end").attr("x",L).attr("y",(t,e)=>m(e)+A/2),c){let e=[];h.selectAll("text").each((function(){e.push(this.getBBox().y+this.getBBox().height)})),n+=+t.max(e)}const x=n+b.top+b.bottom;j.style("width",P+2*k+"px").attr("height",x).attr("transform",`translate(${-k} 0)`)})},pieChart:function({selector:e,dataFile:a,inputIsPercentage:r=!1,pieRad:n=150,pieThick:o=80,margin:i=x}){const c=s,p=y.between,h=y.right,g=y.width,d=y.height,m=y.belowBetween,u=y.below;var f=t.select(e).append("svg").attr("class","sota-pieChart"),b=t.select("body").append("div").attr("class","tooltip"),v=document.querySelector(e).offsetWidth,w=v-i.left-i.right,B=v-i.left-i.right;B<2*n&&(n=B/2),o>n&&(o=50);var A=2*n+i.top+i.bottom;t.csv(a+".csv").then(e=>{const a=e.map(t=>t.label);if(r)y=e.map(t=>t.value);else var s=e.map(t=>t.value),x=t.sum(s,t=>t),y=s.map(t=>100*t/x);const v=t.pie()(y);let C=0,k=[];const $=t.scaleOrdinal().domain(a).range(t.map(a,(t,e)=>"module-fill-"+(e+1)).keys()),j=f.append("g").lower().attr("class","sota-gen-legend").attr("transform",`translate(0 ${i.top})`);if(j.selectAll("nothing").data(e).enter().append("text").attr("class","sota-gen-legend-text").text(t=>t.label).attr("x",(function(){k.push(this.getBBox().width)})).remove(),t.sum(k,t=>t)+3*p+2*h>w){let e=w-t.max(k)-g-p;j.selectAll(".sota-gen-legend-swatch").data(a).join("rect").attr("class",t=>"sota-gen-legend-swatch "+$(t)).attr("x",e).attr("y",(t,e)=>(d+m)*e).attr("width",g).attr("height",d),j.selectAll(".sota-gen-legend-text").data(a).join("text").attr("class","sota-gen-legend-text").text(t=>t).attr("x",e+g+p).attr("y",(t,e)=>(d+m)*e+d/2).attr("alignment-baseline","central"),C=a.length*d+(a.length-1)*m+u}else{let e=w-(t.sum(k,t=>t)+a.length*(g+p)+(a.length-1)*h);j.selectAll(".sota-gen-legend-swatch").data(a).join("rect").attr("class",t=>"sota-gen-legend-swatch "+$(t)).attr("x",(a,l)=>e+l*(g+p+h)+t.sum(k.slice(0,l),t=>t)).attr("y",0).attr("width",g).attr("height",d),j.selectAll(".sota-gen-legend-text").data(a).join("text").attr("class","sota-gen-legend-text").text(t=>t).attr("x",(a,l)=>e+l*(g+p+h)+g+p+t.sum(k.slice(0,l),t=>t)).attr("y",d/2).attr("alignment-baseline","central"),C=d+u}const N=f.append("g").attr("transform","translate("+B/2+","+(n+i.top+C)+")"),P=t.arc().innerRadius(.8*n-.8*o).outerRadius(.8*n),L=t.arc().innerRadius(.9*n).outerRadius(.9*n);N.selectAll(".sota-pieChart-slice").data(v).join("path").attr("class",(t,e)=>"sota-pieChart-slice module-fill-"+(e+1)).attr("d",P).attr("stroke","#fff").style("stroke-width",c).on("mouseover",(function(e,n){t.select(this).attr("opacity",.8),b.style("opacity",1).html(()=>{let t=`<span class="sota-tooltip-label">${a[n]}</span><br/>Percentage: ${l(y[n])}`;return r||(t+="<br/>Number of responses: "+s[n]),t}).style("left",t.event.pageX+"px").style("top",t.event.pageY+"px")})).on("mousemove",e=>{b.style("left",t.event.pageX+"px").style("top",t.event.pageY+"px")}).on("mouseout",(function(e){t.select(this).attr("opacity",1),b.style("opacity",0)})),N.selectAll(".sota-pieChart-polyline").data(v).join("polyline").attr("class","sota-pieChart-polyline").attr("stroke","#999").style("fill","none").attr("stroke-width",2).attr("points",t=>{let e=P.centroid(t),a=L.centroid(t),l=L.centroid(t),s=t.startAngle+(t.endAngle-t.startAngle)/2;return l[0]=.95*n*(s<Math.PI?1:-1),[e,a,l]}),N.selectAll(".sota-pieChart-label").data(v).join("text").attr("class","sota-pieChart-label sota-floatingLabel").text((t,e)=>l(y[e])).attr("alignment-baseline","central").attr("transform",t=>{let e=L.centroid(t),a=t.startAngle+(t.endAngle-t.startAngle)/2;return e[0]=.99*n*(a<Math.PI?1:-1),"translate("+e+")"}).style("text-anchor",t=>t.startAngle+(t.endAngle-t.startAngle)/2<Math.PI?"start":"end"),f.attr("height",A+C)})},lineGraph:function({selector:e,dataFile:a,inputIsPercentage:r=!1,minVal:n=null,maxVal:o=null,height:i=300,customTooltipAppend:c="",prop5:p="value5",prop6:h="value6",margin:g={top:20,bottom:20,left:24,right:0}}){const d=t.select(e).append("svg").attr("class","sota-lineGraph"),m=t.select("body").append("div").attr("class","tooltip"),u=document.querySelector(e).offsetWidth;d.attr("height",i),t.csv(a+".csv").then(a=>{const c=s,p=a.map(t=>t.label),h=a.map(t=>+t.value);if(null==n)n=r?0:t.min(a,t=>t.value);else if(1==n)n=t.min(a,t=>t.value);else if(isNaN(n)||""==n)throw"invalid minVal for graph on "+e;if(null==o)o=r?100:t.max(a,t=>t.value);else if(1==o)o=t.max(a,t=>t.value);else if(isNaN(o)||""==o)throw"invalid maxVal for graph on "+e;const f=t.scaleBand().domain(p.map(t=>t)).range([g.left,u-g.right]),x=t.scaleLinear().domain([n,o]).range([i-g.bottom,g.top]);d.append("g").attr("class","sota-gen-axis sota-gen-xAxis").call(t.axisBottom(f).ticks(a.length).tickSize(-8)).style("transform","translateY("+(i-g.bottom)+"px)"),d.append("g").attr("class","sota-gen-axis sota-gen-YAxis").call(t.axisLeft(x).tickSize(-8)).style("transform","translateX("+g.left+"px)"),d.selectAll(".sota-lineGraph-path").data([h]).join("path").attr("class","sota-lineGraph-path").attr("d",t.line().x((t,e)=>f(p[e])+f.bandwidth()/2).y(t=>x(t))).attr("fill","none").attr("stroke","#bbb").style("stroke-width",3),d.selectAll(".sota-lineGraph-circle").data(h).join("circle").attr("class","sota-lineGraph-circle").attr("cx",(t,e)=>f(p[e])+f.bandwidth()/2).attr("cy",t=>x(t)).attr("r",9).attr("stroke","white").style("stroke-width",c).on("mouseover",(function(e,a){t.select(this).attr("opacity",.8),m.style("opacity",1).html(`<span class="sota-tooltip-label">${p[a]}</span><br/>Value: `+(r?l(e):e)+"</span>").style("left",t.event.pageX+"px").style("top",t.event.pageY+"px")})).on("mousemove",e=>{m.style("left",t.event.pageX+"px").style("top",t.event.pageY+"px")}).on("mouseout",(function(e){t.select(this).attr("opacity",1),m.style("opacity",0)})),d.selectAll(".sota-lineGraph-label").data(h).join("text").attr("class","sota-lineGraph-label sota-floatingLabel").text((t,e)=>{if(r)return t+"%"}).attr("x",(t,e)=>f(p[e])+f.bandwidth()/2).attr("y",t=>x(t)-16).style("text-anchor","middle")})},stackedBarChart:function({selector:a,dataFile:d,inputIsPercentage:m=!1,showXAxis:u=!0,labelStyle:f="onBar",groupLabelStyle:b="none",showLegend:v=!0,prop5:w="value5",prop6:B="value6",margin:A=x}){const C=s,k=r,$=n,j=h,N=c,P=o,L=i,S=g,V=y.between,X=y.right,Y=y.width,I=y.height,q=y.belowBetween,z=y.below,F=p;var M=t.select(a).append("svg"),R=t.select("body").append("div").attr("class","tooltip"),W=document.querySelector(a).offsetWidth,G=W-A.left-A.right;const O=M.append("g").attr("class","sota-stackedBarChart-mainChart").attr("transform",`translate(${A.left+j} ${A.right})`).attr("width",G);t.csv(d+".csv").then(a=>{var s=k+$,r=a.length*s,n=0;"onBar"==b&&(s+=a.length*N,r+=a.length*N,n=N);const o=a.columns.slice(1),i=t.map(a,t=>t.group).keys();var c=[];m?a.forEach(t=>{let e=0,a=[];for(let l of o){let s=+t[l];a.push([s,e]),e+=s}c.push(a)}):a.forEach(e=>{let a=0,l=t.sum(o,t=>+e[t]),s=[];for(let t of o){let r=+e[t]/l*100;s.push([r,a,+e[t]]),a+=r}c.push(s)});const p=t.scaleBand().domain(i).range([0,r]).padding([.2]),h=t.scaleLinear().domain([0,100]).range([0,G]),g=t.scaleOrdinal().domain(o).range(t.map(o,(t,e)=>"module-fill-"+(e+1)).keys());u&&(O.append("g").attr("class","sota-gen-axis sota-gen-xAxis").call(t.axisBottom(h).ticks(a.length).tickSize(-8)).attr("transform","translate(0 "+(r+F)+")"),r+=20+F);var d=0;if(v){let e=[];const a=M.append("g").lower().attr("class","sota-gen-legend").attr("transform",`translate(0 ${A.top})`);if(a.selectAll("nothing").data(o).enter().append("text").attr("class","sota-gen-legend-text").text(t=>t).attr("x",(function(){e.push(this.getBBox().width)})).remove(),t.sum(e,t=>t)+3*V+2*X>G){let l=G-t.max(e)-Y-V;a.selectAll(".sota-gen-legend-swatch").data(o).join("rect").attr("class",t=>"sota-gen-legend-swatch "+g(t)).attr("x",l).attr("y",(t,e)=>(I+q)*e).attr("width",Y).attr("height",I),a.selectAll(".sota-gen-legend-text").data(o).join("text").attr("class","sota-gen-legend-text").text(t=>t).attr("x",l+Y+V).attr("y",(t,e)=>(I+q)*e+I/2).attr("alignment-baseline","central"),d=o.length*I+(o.length-1)*q+z}else{let l=G-(t.sum(e,t=>t)+o.length*(Y+V)+(o.length-1)*X);a.selectAll(".sota-gen-legend-swatch").data(o).join("rect").attr("class",t=>"sota-gen-legend-swatch "+g(t)).attr("x",(a,s)=>l+s*(Y+V+X)+t.sum(e.slice(0,s),t=>t)).attr("y",0).attr("width",Y).attr("height",I),a.selectAll(".sota-gen-legend-text").data(o).join("text").attr("class","sota-gen-legend-text").text(t=>t).attr("x",(a,s)=>l+s*(Y+V+X)+Y+V+t.sum(e.slice(0,s),t=>t)).attr("y",I/2).attr("alignment-baseline","central"),d=I+z}}const x=O.selectAll(".sota-stackedBarChart-group").data(c).join("g").attr("class","sota-stackedBarChart-group").attr("transform",(t,e)=>"translate(0 "+(p(i[e])+n-$)+")");x.selectAll(".sota-stackedBarChart-bar").data(t=>t).join("rect").attr("class",(t,e)=>"sota-stackedBarChart-bar "+g(e)).attr("x",t=>h(t[1])).attr("y",0).attr("width",t=>h(t[0])).attr("height",k).on("mouseover",(function(e,a){t.select(this).attr("opacity",.8),R.style("opacity",1).html(()=>{let t=`<span class="sota-tooltip-label">${o[a]}</span><br/>Percentage: ${l(e[0])}`;return m||(t+="<br/>Number of responses: "+e[2]),t}).style("left",t.event.pageX+"px").style("top",t.event.pageY+"px")})).on("mousemove",()=>{R.style("left",t.event.pageX+"px").style("top",t.event.pageY+"px")}).on("mouseout",(function(e){t.select(this).attr("opacity",1),R.style("opacity",0)})),x.selectAll(".sota-stackedBarChart-separator").data(t=>t).join("rect").attr("class","sota-stackedBarChart-separator").attr("fill","white").attr("x",t=>h(t[1])+h(t[0])).attr("y",0).attr("width",t=>t[0]>0?C:0).attr("height",k),"onBar"==b&&O.selectAll(".sota-stackedBarChart-groupLabel-onBar").data(i).join("text").attr("class","sota-stackedBarChart-groupLabel-onBar sota-gen-groupLabel").text(t=>t).attr("alignment-baseline","bottom").attr("x",0).attr("y",t=>p(t));var y=0;if("onBar"==f)x.selectAll(".sota-stackedBarChart-label-onBar").data(t=>t).join("text").attr("class","sota-stackedBarChart-label-onBar").text(e=>t.format(".1f")(e[0])+"%").attr("alignment-baseline","central").attr("text-anchor","end").attr("x",t=>h(t[1])+h(t[0])-P).attr("y",k/2).call(e,A.left);else if("aboveBar"==f){var w=[];x.selectAll(".sota-stackedBarChart-label-aboveBar-text").data(t=>t).join("text").attr("class","sota-stackedBarChart-label-aboveBar-text").text((e,a)=>`${o[a]}: ${t.format(".1f")(e[0])}%`).attr("x",t=>h(t[1])+h(t[0])/2).attr("y",(function(t){return w.push([this.getBBox().x,this.getBBox().width]),-2*L})).attr("alignment-baseline","bottom");let e=[];!function t(a){if(a==w.length-1)return e[a]=-2,-2;if(w[a][0]+w[a][1]+P>w[a+1][0]){w[a+1][0]=w[a][0]+w[a][1]+P;let l=t(a+1)-1;return e[a]=l,l}return t(a+1),e[a]=-2,-2}(0),x.selectAll(".sota-stackedBarChart-label-aboveBar-line").data(t=>t).join("polyline").attr("class","sota-stackedBarChart-label-aboveBar-line").attr("points",(t,a)=>{let l=h(t[1])+h(t[0])/2,s=k/2,r=l,n=(e[a]+1)*L;return`${l},${s} ${r},${n} ${w[a][0]+w[a][1]},${n}`}).attr("stroke-width",C).attr("stroke",S).attr("fill","none"),x.selectAll(".sota-stackedBarChart-label-aboveBar-text").data(t=>t).join("text").attr("x",(t,e)=>w[e][0]).attr("y",(t,a)=>e[a]*L),y=-1*t.min(e)*L+20}const B=r+A.top+A.bottom+d+y;M.style("width",W+2*j+"px").attr("height",B).attr("transform",`translate(${-j} 0)`),O.attr("transform",`translate(${j} ${A.top+d+y})`).attr("width",G)})},customBarChart:function({selector:e,dataFile:a,shapeFile:l,shapeWidth:r=300,inputIsPercentage:n=!1,margin:c=x}){var p=t.select(e).append("svg"),h=t.select("body").append("div").attr("class","tooltip");const d=p.append("g").attr("class","sota-mainChart");var m=document.querySelector(e).offsetWidth;const u=s,f=o,y=i,b=g;t.xml("shapes/"+l+".svg").then(e=>{let l=document.importNode(e.documentElement,!0),s=t.select(l).select("path").node(),o=0,i=0;p.append(()=>s).attr("class",(function(){return o=this.getBBox().width,i=this.getBBox().height,""})).remove();let g=r/o,x=i*g;p.append("defs").append("clipPath").attr("id","shapeDef").append(()=>s).attr("transform",`scale(${g})`),t.csv(a+".csv").then(e=>{if(n)l=100,s=e.map(e=>t.format(".1f")(e.value)+"%");else var a=e.map(t=>t.value),l=t.sum(a,t=>t),s=a.map(e=>t.format(".1f")(100*e/l)+"%");let o=0,i=[];for(let t of e)i.push(o),o+=+t.value;const g=t.scaleLinear().domain([0,l]).range([0,r]),v=t.scaleOrdinal().domain(t.map(e,t=>t.label)).range(t.map(e,(t,e)=>"module-fill-"+(e+1)).keys());d.selectAll(".sota-customBarChart-bar").data(e).join("rect").attr("class",t=>"sota-customBarChart-bar "+v(t.label)).attr("x",(t,e)=>g(i[e])).attr("y",0).attr("width",t=>g(t.value)).attr("height",x).attr("clip-path","url(#shapeDef)").on("mouseover",(function(l,r){t.select(this).attr("opacity",.8),h.style("opacity",1).html(()=>{let t=`<span class="sota-tooltip-label">${e[r].label}</span><br/>Percentage: ${s[r]}`;return n||(t+="<br/>Number of responses: "+a[r]),t}).style("left",t.event.pageX+"px").style("top",t.event.pageY+"px")})).on("mousemove",e=>{h.style("left",t.event.pageX+"px").style("top",t.event.pageY+"px")}).on("mouseout",(function(e){t.select(this).attr("opacity",1),h.style("opacity",0)})),d.selectAll(".sota-customBarChart-separator").data(e).join("rect").attr("class","sota-customBarChart-separator").attr("x",(t,e)=>0==e?-u:g(i[e])).attr("y",0).attr("width",u).attr("height",x).attr("fill","white").attr("clip-path","url(#shapeDef)");var w=[];d.selectAll(".sota-customBarChart-label-aboveBar-text").data(e).join("text").attr("class","sota-customBarChart-label-aboveBar-text").text((t,e)=>`${t.label}: ${s[e]}`).attr("x",(t,e)=>g(i[e])+g(t.value)/2+f).attr("y",(function(t){return w.push([this.getBBox().x,this.getBBox().width]),x+3*y})).attr("alignment-baseline","top");let B=[];!function t(e){if(e==w.length-1)return B[e]=3,3;if(w[e][0]+w[e][1]+2*f>w[e+1][0]){w[e+1][0]=w[e][0]+w[e][1]+2*f;let a=t(e+1)+1;return B[e]=a,a}return t(e+1),B[e]=3,3}(0),d.selectAll(".sota-customBarChart-label-aboveBar-line").data(e).join("polyline").attr("class","sota-customBarChart-label-aboveBar-line").attr("points",(t,e)=>{let a=g(i[e])+g(t.value)/2,l=x-y,s=a,r=x+(B[e]+1)*y;return`${a},${l} ${s},${r} ${w[e][0]+w[e][1]},${r}`}).attr("stroke-width",u).attr("stroke",b).attr("fill","none"),d.selectAll(".sota-customBarChart-label-aboveBar-text").data(e).join("text").attr("x",(t,e)=>w[e][0]).attr("y",(t,e)=>x+B[e]*y);let A=t.max(B)*y+20,C=x+c.top+c.bottom+A;p.attr("height",C),d.attr("transform",`translate(${c.left} ${c.top})`).attr("width",m-c.left-c.right)})})},columnChart:function({selector:e,dataFile:a,inputIsPercentage:s=!1,displayPercentage:r=!0,totalResp:n=null,maxVal:o=null,minVal:i=null,mainHeight:c=d,showLegend:p=!1,margin:g={top:20,bottom:20,left:24,right:0}}){const f=h,x=m,b=u,v=y.between,w=y.right,B=y.width,A=y.height,C=y.belowBetween,k=y.below,$=t.select(e).append("svg"),j=t.select("body").append("div").attr("class","tooltip"),N=$.append("g").attr("class","sota-mainChart"),P=document.querySelector(e).offsetWidth,L=P-g.left-g.right;t.csv(a+".csv").then(a=>{let h;s?h=a.map(t=>+t.value).keys:(n=null==n?t.sum(a,t=>+t.value):n,h=a.map(t=>+t.value/n*100));const d=r||s?h:a.map(t=>+t.value),m=a.map(t=>t.label);if(null===i)i=s||r?0:t.min(d);else if(!0===i)i=t.min(d);else if(isNaN(i)||""===i)throw"invalid minVal for graph on "+e;if(null===o)o=s||r?100:t.max(d);else if(!0===o)o=t.max(d);else if(isNaN(o)||""===o)throw"invalid maxVal for graph on "+e;const u=t.scaleBand().domain(m).range([0,L]).padding([.3]),y=t.scaleLinear().domain([i,o]).range([c,0]),S=t.scaleOrdinal().domain(m).range(t.map(m,(t,e)=>"module-fill-"+(e+1)).keys());let V,X=0,Y=!1;if(p){let e=[];const l=$.append("g").lower().attr("class","sota-gen-legend").attr("transform",`translate(0 ${g.top})`);if(l.selectAll("nothing").data(a).enter().append("text").attr("class","sota-gen-legend-text").text(t=>t.label).attr("x",(function(){e.push(this.getBBox().width)})).remove(),t.sum(e,t=>t)+e.length*v+(e.length-1)*w>L){let a=L-t.max(e)-B-v;l.selectAll(".sota-gen-legend-swatch").data(m).join("rect").attr("class",t=>"sota-gen-legend-swatch "+S(t)).attr("x",a).attr("y",(t,e)=>(A+C)*e).attr("width",B).attr("height",A),l.selectAll(".sota-gen-legend-text").data(m).join("text").attr("class","sota-gen-legend-text").text(t=>t).attr("x",a+B+v).attr("y",(t,e)=>(A+C)*e+A/2).attr("alignment-baseline","central"),X=m.length*A+(m.length-1)*C+k}else{let a=L-(t.sum(e,t=>t)+m.length*(B+v)+(m.length-1)*w);l.selectAll(".sota-gen-legend-swatch").data(m).join("rect").attr("class",t=>"sota-gen-legend-swatch "+S(t)).attr("x",(l,s)=>a+s*(B+v+w)+t.sum(e.slice(0,s),t=>t)).attr("y",0).attr("width",B).attr("height",A),l.selectAll(".sota-gen-legend-text").data(m).join("text").attr("class","sota-gen-legend-text").text(t=>t).attr("x",(l,s)=>a+s*(B+v+w)+B+v+t.sum(e.slice(0,s),t=>t)).attr("y",A/2).attr("alignment-baseline","central"),X=A+k}}else{V=N.append("g").attr("class","sota-gen-axis sota-gen-xAxis").call(t.axisBottom(u).tickSize(0)).attr("transform",`translate(0 ${c})`);const e=V.selectAll("text"),a=e.nodes();for(let t in a){if(t==a.length-1)continue;let e=a[+t].getBBox(),l=a[+t+1].getBBox();if(e.x+e.width>l.x){Y=!0;break}}Y&&e.attr("text-anchor","end").style("transform",`translateY(4px) rotate(-${b}deg)`)}N.append("g").attr("class","sota-gen-axis sota-gen-yAxis").call(t.axisLeft(y).tickSize(-x));if(N.selectAll(".sota-columnChart-bar").data(d).join("rect").attr("class",(t,e)=>{let a="sota-columnChart-bar sota-gen-bar";return a+=p?" "+S(m[e]):"",a}).attr("x",(t,e)=>u(m[e])).attr("y",t=>y(t)).attr("width",u.bandwidth()).attr("height",t=>c-y(t)).on("mouseover",(function(e,r){t.select(this).attr("opacity",.8),j.style("opacity",1).html(()=>{let t=`<span class="sota-tooltip-label">${m[r]}</span><br/>Percentage: ${l(h[r])}`;return s||(t+="<br/>Number of responses: "+a[r].value),t}).style("left",t.event.pageX+"px").style("top",t.event.pageY+"px")})).on("mousemove",e=>{j.style("left",t.event.pageX+"px").style("top",t.event.pageY+"px")}).on("mouseout",(function(e){t.select(this).attr("opacity",1),j.style("opacity",0)})),p)c+=X;else if(Y){let e=[];const a=V.select("text").node().getBBox(),l=a.y,s=a.height;V.selectAll("text").each((function(){e.push(this.getBBox().width)}));const r=t.max(e)*Math.sin(b*Math.PI/180),n=s*Math.cos(b*Math.PI/180);c+=l+r+n}else{let e=[];V.selectAll("text").each((function(){e.push(this.getBBox().y+this.getBBox().height)})),c+=+t.max(e)}let I=c+g.top+g.bottom;$.style("width",P+2*f+"px").attr("height",I).attr("transform",`translate(${-f} 0)`),N.attr("transform",`translate(${g.left+f} ${g.top+X})`).attr("width",L)})},groupedBarChart:function({selector:e,dataFile:a,totalResp:s=null,inputIsPercentage:r=!1,displayPercentage:n=!0,minVal:o=0,maxVal:i=null,margin:g=x}){const d=f.barHeight,m=f.barMargin,u=h,y=c,b=p,v=t.select(e).append("svg"),w=t.select("body").append("div").attr("class","tooltip"),B=v.append("g").attr("class","sota-mainChart"),A=document.querySelector(e).offsetWidth,C=A-g.left-g.right;t.csv(a+".csv").then(a=>{window.wow=a;const c=a.columns.splice(1),p=t.map(a,t=>t.group).keys(),h=t.map(a,e=>{let a=[];for(let t of c)a.push(+e[t]);return t.max(a)}).keys(),f=t.max(h,t=>+t);if(null==i)i=r||n?100:f;else if(isNaN(i)||""===i)throw"invalid maxVal for graph on "+e;const x=d+m,k=x*c.length;let $=(k+y)*a.length;const j=t.scaleLinear().domain([o,i]).range([0,C]),N=t.scaleOrdinal().domain(t.map(a,t=>t.group)).range(t.map(a,(t,e)=>(k+y)*e).keys()),P=t.scaleOrdinal().domain(c).range(t.map(c,(t,e)=>x*e).keys());B.append("g").attr("class","sota-gen-axis sota-gen-xAxis sota-groupedBarChart-xAxis").call(t.axisBottom(j).tickSize(-($+b))).attr("transform","translate(0 "+($+b)+")");$+=20+b;const L=B.selectAll(".sota-groupedBarChart-group").data(a).join("g").attr("class","sota-groupedBarChart-group").attr("transform",(t,e)=>`translate(0 ${N(t.group)})`),S=t.scaleOrdinal().domain(c).range(t.map(c,(t,e)=>"module-fill-"+(e+1)).keys());L.selectAll(".sota-gen-bar").data(t=>{let e=[];for(let a of c)e.push(+t[a]);return e}).join("rect").attr("class",(t,e)=>"sota-gen-bar "+S(c[e])).attr("y",(t,e)=>+P(c[e])+ +y).attr("x",0).attr("width",(t,e)=>j(r?t:t/s[c[e]]*100)).attr("height",d).on("mouseover",(function(e,a){t.select(this).attr("opacity",.8),w.style("opacity",1).html(()=>{let t=`<span class="sota-tooltip-label">${c[a]}</span><br/>Percentage: ${l(r?e:e/s[c[a]]*100)}`;return r||(t+="<br/>Number of responses: "+e),t}).style("left",t.event.pageX+"px").style("top",t.event.pageY+"px")})).on("mousemove",()=>{w.style("left",t.event.pageX+"px").style("top",t.event.pageY+"px")}).on("mouseout",(function(e){t.select(this).attr("opacity",1),w.style("opacity",0)})),B.selectAll(".sota-gen-groupLabel").data(p).join("text").attr("class","sota-gen-groupLabel").text(t=>t).attr("alignment-baseline","bottom").attr("x",0).attr("y",t=>+N(t)+ +y).attr("transform","translate(0 -8)");let V=$+g.top+g.bottom;v.style("width",A+2*u+"px").attr("height",V).attr("transform",`translate(${-u} 0)`),B.attr("transform",`translate(${g.left+u} ${g.top})`).attr("width",C)})},stackedColumnChart:function({selector:e,dataFile:a,inputIsPercentage:r=!1,displayPercentage:n=!0,totalResp:o=null,maxVal:i=null,minVal:c=null,mainHeight:p=d,margin:g={top:20,bottom:20,left:24,right:0}}){const u=m,f=s,x=h,b=y.between,v=y.right,w=y.width,B=y.height,A=y.belowBetween,C=y.below,k=t.select(e).append("svg"),$=t.select("body").append("div").attr("class","tooltip"),j=k.append("g").attr("class","sota-stackedColumnChart-mainChart"),N=document.querySelector(e).offsetWidth,P=N-g.left-g.right;t.csv(a+".csv").then(a=>{const s=a.columns.slice(1),o=t.map(a,t=>t.group).keys();var h=[];r?a.forEach(t=>{let e=0,a=[];for(let l of s){let s=+t[l];a.push([s,e]),e+=s}h.push(a)}):a.forEach(e=>{let a=0,l=t.sum(s,t=>+e[t]),r=[];for(let t of s){let s=+e[t]/l*100;r.push([s,a,+e[t]]),a+=s}h.push(r)});const d=n||r?h:a.map(t=>+t.value);if(null===c)c=r||n?0:t.min(d);else if(!0===c)c=t.min(d);else if(isNaN(c)||""===c)throw"invalid minVal for graph on "+e;if(null===i)i=r||n?100:t.max(d);else if(!0===i)i=t.max(d);else if(isNaN(i)||""===i)throw"invalid maxVal for graph on "+e;const m=t.scaleBand().domain(o).range([0,P]).padding([.3]),y=t.scaleLinear().domain([c,i]).range([p,0]),L=t.scaleOrdinal().domain(s).range(t.map(s,(t,e)=>"module-fill-"+(e+1)).keys()),S=(j.append("g").attr("class","sota-gen-axis sota-gen-yAxis").call(t.axisLeft(y).tickSize(-u)),j.append("g").attr("class","sota-gen-axis sota-gen-xAxis").call(t.axisBottom(m).ticks(a.length).tickSize(-u)).attr("transform","translate(0 "+p+")"));let V=0,X=[];const Y=k.append("g").lower().attr("class","sota-gen-legend").attr("transform",`translate(0 ${g.top})`);if(Y.selectAll("nothing").data(s).enter().append("text").attr("class","sota-gen-legend-text").text(t=>t).attr("x",(function(){X.push(this.getBBox().width)})).remove(),t.sum(X,t=>t)+X.length*b+(X.length-1)*v>P){let e=P-t.max(X)-w-b;Y.selectAll(".sota-gen-legend-swatch").data(s).join("rect").attr("class",t=>"sota-gen-legend-swatch "+L(t)).attr("x",e).attr("y",(t,e)=>(B+A)*e).attr("width",w).attr("height",B),Y.selectAll(".sota-gen-legend-text").data(s).join("text").attr("class","sota-gen-legend-text").text(t=>t).attr("x",e+w+b).attr("y",(t,e)=>(B+A)*e+B/2).attr("alignment-baseline","central"),V=s.length*B+(s.length-1)*A+C}else{let e=P-(t.sum(X,t=>t)+s.length*(w+b)+(s.length-1)*v);Y.selectAll(".sota-gen-legend-swatch").data(s).join("rect").attr("class",t=>"sota-gen-legend-swatch "+L(t)).attr("x",(a,l)=>e+l*(w+b+v)+t.sum(X.slice(0,l),t=>t)).attr("y",0).attr("width",w).attr("height",B),Y.selectAll(".sota-gen-legend-text").data(s).join("text").attr("class","sota-gen-legend-text").text(t=>t).attr("x",(a,l)=>e+l*(w+b+v)+w+b+t.sum(X.slice(0,l),t=>t)).attr("y",B/2).attr("alignment-baseline","central"),V=B+C}const I=j.selectAll(".sota-stackedColumnChart-group").data(h).join("g").attr("class","sota-stackedColumnChart-group").attr("transform",(t,e)=>"translate("+m(o[e])+" 0)");I.selectAll(".sota-stackedColumnChart-bar").data(t=>t).join("rect").attr("class",(t,e)=>"sota-stackedColumnChart-bar "+L(e)).attr("x",0).attr("y",t=>y(t[0]+t[1])).attr("width",m.bandwidth()).attr("height",t=>p-y(t[0])).on("mouseover",(function(e,a){t.select(this).attr("opacity",.8),$.style("opacity",1).html(()=>{let t=`<span class="sota-tooltip-label">${s[a]}</span><br/>Percentage: ${l(e[0])}`;return r||(t+="<br/>Number of responses: "+e[2]),t}).style("left",t.event.pageX+"px").style("top",t.event.pageY+"px")})).on("mousemove",()=>{$.style("left",t.event.pageX+"px").style("top",t.event.pageY+"px")}).on("mouseout",(function(e){t.select(this).attr("opacity",1),$.style("opacity",0)})),I.selectAll(".sota-stackedColumnChart-separator").data(t=>t).join("rect").attr("class","sota-stackedColumnChart-separator").attr("fill","white").attr("x",0).attr("y",(t,e)=>y(t[0])+y(t[1])-p).attr("height",t=>t[0]>0?f:0).attr("width",m.bandwidth()),p+=V;{let e=[];S.selectAll("text").each((function(){e.push(this.getBBox().y+this.getBBox().height)})),p+=+t.max(e)}let q=p+g.top+g.bottom+V;k.style("width",N+2*x+"px").attr("height",q).attr("transform",`translate(${-x} 0)`),j.attr("transform",`translate(${g.left+x} ${g.top+V})`).attr("width",P)})}};return b}));
